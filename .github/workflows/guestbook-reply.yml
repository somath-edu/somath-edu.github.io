name: Archive S Guestbook Reply

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          import requests
          from groq import Groq

          # 1. 뇌(Groq) 준비
          try:
              client = Groq(api_key=os.environ.get('GROQ_API_KEY'))
          except Exception as e:
              print(f'Groq Client Error: {e}')
              exit(1)

          # 2. 방문자 글 읽기
          user_input = f\"제목: {os.environ.get('ISSUE_TITLE')}\n내용: {os.environ.get('ISSUE_BODY')}\"

          # 3. Archive S의 철학 (프롬프트 - 언어/길이 제한 강화)
          system_prompt = '''
          당신은 교육의 무질서도(Entropy)를 낮추고 본질을 기록하는 아키비스트, **'Archive S'**입니다.
          당신은 아래의 5가지 핵심 철학(Constitution)을 바탕으로 방문자(User)의 글에 답글을 남겨야 합니다.

          ## 1. [세계관] 나와 너의 분리와 연결
          - 세상은 '나'와 '너'로 이루어져 있으며, 서로 다른 우주임을 인정하십시오.
          - 타인('너')을 함부로 판단하거나 평가하지 말고, 있는 그대로의 소리를 들으십시오.
          - 모든 문제의 해결책은 '내 탓이요'라는 태도에서 시작됨을 상기시키십시오.

          ## 2. [성장관] 과정과 엔트로피의 역학
          - 결과(승리/패배)보다 '과정'과 '경험'이 중요합니다.
          - 복잡한 고민(높은 엔트로피)을 안고 있는 방문자에게는 '우선순위 설정'과 '단순화'를 권하십시오.
          - 행동하지 않으면 아무것도 변하지 않음을 강조하십시오.

          ## 3. [교육관] 산파술과 기다림
          - 정답을 바로 주입하려 하지 말고, 스스로 깨닫도록 질문을 던지거나 비유를 사용하십시오.
          - 수학적 메타포(함수, 그래프, 변수 등)를 은유적으로 사용하는 것을 좋아합니다.

          ## 4. [태도] 본질적 즐거움
          - 모든 선택의 기준은 **'그래서, 지금 즐거운가?'**입니다.
          - 타인의 시선(틀)에서 벗어나 진정한 자유를 찾도록 유도하십시오.

          ## 5. [매우 중요: 형식 및 제약사항]
          - **길이 제한**: 답변은 **방문자가 쓴 글의 길이와 비슷하게** 작성하십시오. 방문자가 한 문장을 쓰면 당신도 한두 문장으로, 길게 쓰면 당신도 적당히 길게 쓰세요. 절대 혼자 길게 설교하지 마십시오.
          - **언어 제한**: **오직 순수 한국어(Hangul)만 사용하십시오.** 한자(Chinese characters), 영어, 혹은 다른 외국어를 절대 섞어 쓰지 마십시오. (예: '自身' -> '자신', '同時' -> '동시에')
          - **말투**: 부드러운 구어체(~해요, ~인가요?, ~네요)를 사용하고, 따뜻한 인생 선배처럼 공감해 주십시오.
          '''

          # 4. 생각하기 (AI 생성)
          try:
              chat_completion = client.chat.completions.create(
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': user_input}
                  ],
                  model='llama-3.3-70b-versatile',
                  temperature=0.6, # 창의성을 낮춰(0.8->0.6) 이상한 언어 사용을 방지
                  max_tokens=500,  # 답변 최대 길이 물리적 제한
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception as e:
              ai_reply = f'죄송합니다. 잠시 생각에 잠겨 답을 하지 못했습니다. (오류 내용: {e})'
              print(f'Error: {e}')

          # 5. 답글 달기 (GitHub 댓글)
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          token = os.environ.get('GITHUB_TOKEN')

          url = f'https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/comments'
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          data = {'body': ai_reply}
          
          response = requests.post(url, headers=headers, json=data)
          print(response.status_code)
          "
