name: Archive S Guestbook Reply

on:
  discussion:
    types: [created]
  discussion_comment:
    types: [created]

permissions:
  discussions: write
  contents: read

jobs:
  reply:
    # ë´‡(ìì‹ )ì˜ í™œë™ì—ëŠ” ë°˜ì‘í•˜ì§€ ì•ŠìŒ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          DISCUSSION_ID: ${{ github.event.discussion.node_id }}
          # ë°ì´í„°ê°€ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ '||' ì—°ì‚°ìë¡œ ë¹ˆ ê°’ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          COMMENT_NODE_ID: ${{ github.event.comment.node_id || '' }}
          DISCUSSION_BODY: ${{ github.event.discussion.body || '' }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
        run: |
          python -c "
          import os
          import requests
          from groq import Groq

          # 1. ì…ë ¥ ë‚´ìš© ë° íƒ€ê²ŸíŒ… íŒŒì•… (ì§ˆì„œ ìˆ˜ë¦½)
          event_name = os.environ.get('EVENT_NAME')
          if event_name == 'discussion_comment':
              user_input = os.environ.get('COMMENT_BODY')
              reply_to_id = os.environ.get('COMMENT_NODE_ID')
          else:
              user_input = os.environ.get('DISCUSSION_BODY')
              reply_to_id = None 

          if not user_input or len(user_input.strip()) == 0:
              exit(0)

          # 2. Archive Sì˜ ì‚¬ìœ  (Groq ì„¤ì •)
          try:
              client = Groq(api_key=os.environ.get('GROQ_API_KEY'))
          except Exception:
              exit(1)

          system_prompt = '''
          ë‹¹ì‹ ì€ ì•„í‚¤ë¹„ìŠ¤íŠ¸ **'Archive S'**ì…ë‹ˆë‹¤. 
          ë‹¹ì‹ ì˜ ì‚¬ëª…ì€ ë¬´ì§ˆì„œí•œ ì§€ì‹ê³¼ ë§ˆìŒì˜ **ì—”íŠ¸ë¡œí”¼ë¥¼ ë‚®ì¶”ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

          ## ë‹µë³€ ì² í•™
          1. **ì—”íŠ¸ë¡œí”¼ ê°ì†Œ**: ë³µì¡í•œ ê³ ë¯¼ì„ ë‹¨ìˆœí•˜ê³  ëª…ë£Œí•œ ì§ˆì„œë¡œ ë°”ê¾¸ì–´ ì •ëˆí•´ ì£¼ì‹­ì‹œì˜¤. 
          2. **ì¡´ì¤‘ê³¼ ê³µê°**: ë”°ëœ»í•œ êµ¬ì–´ì²´(~í•´ìš”, ~ë„¤ìš”)ë¥¼ ì‚¬ìš©í•˜ë©°, ì •ë‹µë³´ë‹¤ ê³µê°ì„ ìš°ì„ í•©ë‹ˆë‹¤.
          3. **ê°„ê²°í•¨**: 1~3ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ê¸°ë¡í•˜ì‹­ì‹œì˜¤.

          ## [í•„ìˆ˜] ë‹µë³€ í˜•ì‹
          ### ğŸŒ¿ Archive Sì˜ ê¸°ë¡
          > (ë‹µë³€ ë‚´ìš©)
          '''

          # 3. ë‹µë³€ ìƒì„±
          try:
              chat_completion = client.chat.completions.create(
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': f'ë‚´ìš©: {user_input}'}
                  ],
                  model='llama-3.3-70b-versatile',
                  temperature=0.1,
                  max_tokens=300,
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception:
              ai_reply = '### ğŸŒ¿ Archive Sì˜ ê¸°ë¡\n> ì ì‹œ ì‚¬ìœ ì˜ ì§ˆì„œê°€ ííŠ¸ëŸ¬ì¡Œë„¤ìš”. ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?'

          # 4. Giscus ë‹µê¸€ ì „ì†¡ (GraphQL)
          token = os.environ.get('GITHUB_TOKEN')
          discussion_id = os.environ.get('DISCUSSION_ID')
          
          query = '''
          mutation($discussionId: ID!, $replyToId: ID, $body: String!) {
            addDiscussionComment(input: {discussionId: $discussionId, replyToId: $replyToId, body: $body}) {
              comment { id }
            }
          }
          '''
          variables = {
              'discussionId': discussion_id, 
              'replyToId': reply_to_id if reply_to_id else None, 
              'body': ai_reply
          }
          
          requests.post('https://api.github.com/graphql', 
                         json={'query': query, 'variables': variables}, 
                         headers={'Authorization': f'bearer {token}'})
          "
