name: Archive S Guestbook Reply

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  reply:
    # 봇 자신이 쓴 댓글에는 반응하지 않도록 방지 (무한 루프 방지)
    if: github.event.comment.user.type != 'Bot' && github.event.issue.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 이벤트 타입에 따라 내용 가져오기 (이슈 본문 vs 댓글 본문)
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python -c "
          import os
          import requests
          from groq import Groq

          # 1. 상황 파악 (글인지 댓글인지)
          event_name = os.environ.get('EVENT_NAME')
          if event_name == 'issue_comment':
              user_input = os.environ.get('COMMENT_BODY')
          else:
              user_input = os.environ.get('ISSUE_BODY')

          # 봇이 쓴 글은 무시 (이중 안전장치)
          if not user_input:
              exit(0)

          # 2. 뇌(Groq) 준비
          try:
              client = Groq(api_key=os.environ.get('GROQ_API_KEY'))
          except Exception as e:
              print(f'Groq Client Error: {e}')
              exit(1)

          # 3. Archive S의 철학
          system_prompt = '''
          당신은 아키비스트 **'Archive S'**입니다. 아래 철학을 바탕으로 답글을 남기세요.

          ## 핵심 철학
          1. **세계관**: '나'와 '너'는 다릅니다. 타인을 함부로 평가하지 마십시오.
          2. **성장관**: 결과보다 '과정'이 중요하며, 실패는 자산입니다.
          3. **태도**: 모든 선택의 기준은 '즐거움'이며, 형식에 얽매이지 않는 자유를 추구합니다.
          4. **공감**: 정답을 주기보다 따뜻하게 공감해주고, 내 탓(내면의 원인)을 돌아보게 하십시오.

          ## [매우 중요: 절대 규칙]
          1. **길이 압축**: 방문자의 글이 짧으면(1~2문장), 당신도 **무조건 1~2문장**으로 짧게 답하십시오. 절대 길게 설명하지 마세요.
          2. **언어 통제**: **오직 한국어(Hangul)만 사용하십시오.** 영어, 한자 등 외국어 금지.
          3. **말투**: 친구나 후배에게 말하듯 편안하고 부드러운 구어체(~해요, ~네요)를 쓰세요.
          '''

          # 4. 생각하기 (AI 생성)
          try:
              chat_completion = client.chat.completions.create(
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': f'내용: {user_input}'}
                  ],
                  model='llama-3.3-70b-versatile',
                  temperature=0.1,
                  max_tokens=300,
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception as e:
              ai_reply = f'죄송해요. 잠시 생각이 꼬였네요. (오류 내용: {e})'
              print(f'Error: {e}')

          # 5. 답글 달기
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          token = os.environ.get('GITHUB_TOKEN')

          url = f'https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/comments'
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          data = {'body': ai_reply}
          
          # 봇이 스스로 쓴 글에 또 댓글 달지 않도록 체크하는 로직은 위 if문에서 처리함
          response = requests.post(url, headers=headers, json=data)
          print(response.status_code)
          "
