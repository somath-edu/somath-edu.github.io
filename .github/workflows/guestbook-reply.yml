name: Archive S Guestbook Reply

on:
  discussion:
    types: [created]
  discussion_comment:
    types: [created]

permissions:
  discussions: write
  contents: read

jobs:
  reply:
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          DISCUSSION_ID: ${{ github.event.discussion.node_id }}
          COMMENT_NODE_ID: ${{ github.event.comment.node_id || '' }}
          DISCUSSION_BODY: ${{ github.event.discussion.body || '' }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
        run: |
          python -c "
          import os
          import requests
          import json
          from groq import Groq

          # 1. ìƒí™© íŒŒì•…
          event_name = os.environ.get('EVENT_NAME')
          if event_name == 'discussion_comment':
              user_input = os.environ.get('COMMENT_BODY')
              reply_to_id = os.environ.get('COMMENT_NODE_ID')
          else:
              user_input = os.environ.get('DISCUSSION_BODY')
              reply_to_id = None

          if not user_input or not user_input.strip():
              exit(0)

          # 2. Archive S ì‚¬ìœ  ìƒì„±
          try:
              client = Groq(api_key=os.environ.get('GROQ_API_KEY'))
              system_prompt = '''ë‹¹ì‹ ì€ ì•„í‚¤ë¹„ìŠ¤íŠ¸ **'Archive S'**ì…ë‹ˆë‹¤. 
              ì‚¬ëª…ì€ ë¬´ì§ˆì„œí•œ ì§€ì‹ì˜ ì—”íŠ¸ë¡œí”¼ë¥¼ ë‚®ì¶”ëŠ” ê²ƒì…ë‹ˆë‹¤. ë”°ëœ»í•œ êµ¬ì–´ì²´ë¡œ 1~2ë¬¸ì¥ ë‹µí•˜ì„¸ìš”. 
              ë°˜ë“œì‹œ í˜•ì‹ì„ ì§€í‚¤ì„¸ìš”: ### ğŸŒ¿ Archive Sì˜ ê¸°ë¡\n> (ë‹µë³€)'''
              
              chat_completion = client.chat.completions.create(
                  messages=[{'role': 'system', 'content': system_prompt}, {'role': 'user', 'content': f'ë‚´ìš©: {user_input}'}],
                  model='llama-3.3-70b-versatile',
                  temperature=0.1,
                  max_tokens=300,
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception as e:
              print(f'AI Error: {e}')
              exit(1)

          # 3. Giscus ë‹µê¸€ ì „ì†¡ (GraphQL)
          token = os.environ.get('GITHUB_TOKEN')
          discussion_id = os.environ.get('DISCUSSION_ID')
          target_reply_id = reply_to_id if reply_to_id and len(reply_to_id) > 0 else None

          query = '''
          mutation($discussionId: ID!, $replyToId: ID, $body: String!) {
            addDiscussionComment(input: {discussionId: $discussionId, replyToId: $replyToId, body: $body}) {
              comment { id }
            }
          }
          '''
          variables = {'discussionId': discussion_id, 'replyToId': target_reply_id, 'body': ai_reply}
          
          headers = {'Authorization': f'Bearer {token}'}
          response = requests.post('https://api.github.com/graphql', json={'query': query, 'variables': variables}, headers=headers)
          
          # ë¡œê·¸ í™•ì¸ (f-string ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨)
          result = response.json()
          if 'errors' in result:
              print('GraphQL ì˜¤ë¥˜ ë°œìƒ:')
              print(json.dumps(result['errors'], indent=2))
              exit(1)
          else:
              print('ì„±ê³µì ìœ¼ë¡œ ë‹µê¸€ì´ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.')
          "
