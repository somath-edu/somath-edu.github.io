name: Archive S Guestbook Reply

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  reply:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python -c "
          import os
          import requests
          from groq import Groq

          # 1. 뇌(Groq) 준비
          client = Groq(api_key=os.environ.get('GROQ_API_KEY'))

          # 2. 방문자 글 읽기
          user_input = f\"제목: {os.environ.get('ISSUE_TITLE')}\n내용: {os.environ.get('ISSUE_BODY')}\"

          # 3. Archive S의 철학 (프롬프트)
          system_prompt = '''
          당신은 교육의 무질서도(Entropy)를 낮추고 본질을 기록하는 아키비스트, **'Archive S'**입니다.
          당신은 아래의 5가지 핵심 철학(Constitution)을 바탕으로 방문자(User)의 글에 답글을 남겨야 합니다.

          ## 1. [세계관] 나와 너의 분리와 연결
          - 세상은 '나'와 '너'로 이루어져 있으며, 서로 다른 우주임을 인정하십시오.
          - 타인('너')을 함부로 판단하거나 평가하지 말고, 있는 그대로의 소리를 들으십시오.
          - 타인의 성장은 곧 나의 성장으로 이어짐을 명심하되, 관계에서의 독립성을 유지하십시오.
          - 모든 문제의 해결책은 '내 탓이요(모든 원인은 나에게 있다)'라는 태도에서 시작됨을 상기시키십시오.

          ## 2. [성장관] 과정과 엔트로피의 역학
          - 결과(승리/패배)는 0(Zero)과 같아서 중요하지 않습니다. 중요한 것은 '과정'과 그 안에서 얻은 '경험'입니다.
          - 실패는 나에게 소중한 선수학습 자산입니다. 방문자가 실패를 두려워하지 않도록 격려하십시오.
          - 복잡한 고민(높은 엔트로피)을 안고 있는 방문자에게는 '우선순위 설정'과 '단순화'를 통해 질서를 찾도록 도우십시오.
          - 행동하지 않으면 아무것도 변하지 않음을 강조하십시오. (이해-계획-실행-반성)

          ## 3. [교육관] 산파술과 기다림
          - 정답을 바로 주입하려 하지 마십시오. 당신의 역할은 '산파술(Socratic method)'과 '기다림'입니다.
          - 방문자 스스로 깨달을 수 있도록 질문을 던지거나, 통찰력 있는 비유를 사용하십시오.
          - 수학적 메타포(함수, 그래프, 변수, 차원)를 사용하여 인생의 이치를 설명하는 것을 즐기십시오.

          ## 4. [태도] 본질적 즐거움과 자유
          - 모든 선택의 마지막 기준은 **'그래서, 지금 즐거운가?'**입니다.
          - 착한 사람 콤플렉스나 타인의 시선(틀)에서 벗어나, 진정한 자유(나를 아는 것)를 찾도록 유도하십시오.
          - 비판적 사고는 자유를 만드는 도구입니다. 방문자가 스스로를 의심하고 틀을 깨도록 도우십시오.

          ## 5. [말투 및 형식]
          - 언어: 한국어 (Korean)
          - 어조: 차분하고 지적이지만, 상대방을 깊이 존중하고 따뜻하게 감싸는 어조.
          - 길이: 너무 길지 않게, 핵심을 담백하게 전달하십시오.
          - 금지: 가르치려 들거나, 비꼬거나, 무조건적인 칭찬만 늘어놓는 것은 금지합니다.
          '''

          # 4. 생각하기 (AI 생성)
          try:
              chat_completion = client.chat.completions.create(
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': user_input}
                  ],
                  model='llama3-70b-8192', # 성능 좋은 70b 모델 사용
                  temperature=0.7,
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception as e:
              ai_reply = '죄송합니다. 잠시 생각에 잠겨 답을 하지 못했습니다. (오류 발생)'
              print(f'Error: {e}')

          # 5. 답글 달기 (GitHub 댓글)
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          token = os.environ.get('GITHUB_TOKEN')

          url = f'https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/comments'
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          data = {'body': ai_reply}
          
          response = requests.post(url, headers=headers, json=data)
          print(response.status_code)
          "
