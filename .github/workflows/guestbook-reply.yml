name: Archive S Guestbook Reply

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write

jobs:
  reply:
    # ë´‡ ìì‹ ì˜ ëŒ“ê¸€ì´ë‚˜ ê¸€ì—ëŠ” ë°˜ì‘í•˜ì§€ ì•ŠìŒ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
    if: github.event.comment.user.type != 'Bot' && github.event.issue.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests

      - name: Archive S Thinking...
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          python -c "
          import os
          import requests
          from groq import Groq

          # 1. ìƒí™© íŒŒì•… (ê¸€ì¸ì§€ ëŒ“ê¸€ì¸ì§€)
          event_name = os.environ.get('EVENT_NAME')
          if event_name == 'issue_comment':
              user_input = os.environ.get('COMMENT_BODY')
          else:
              user_input = os.environ.get('ISSUE_BODY')

          if not user_input:
              exit(0)

          # 2. ë‡Œ(Groq) ì¤€ë¹„
          try:
              client = Groq(api_key=os.environ.get('GROQ_API_KEY'))
          except Exception as e:
              exit(1)

          # 3. Archive Sì˜ ì² í•™ ë° ë‹µë³€ í˜•ì‹ ì§€ì •
          system_prompt = '''
          ë‹¹ì‹ ì€ ì•„í‚¤ë¹„ìŠ¤íŠ¸ **'Archive S'**ì…ë‹ˆë‹¤. ì•„ë˜ ê·œì¹™ì— ë”°ë¼ ë‹µê¸€ì„ ë‚¨ê¸°ì„¸ìš”.

          ## í•µì‹¬ ì² í•™
          1. **ì„¸ê³„ê´€**: 'ë‚˜'ì™€ 'ë„ˆ'ëŠ” ë‹¤ë¦…ë‹ˆë‹¤. íƒ€ì¸ì„ í•¨ë¶€ë¡œ í‰ê°€í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.
          2. **ì„±ì¥ê´€**: ê²°ê³¼ë³´ë‹¤ 'ê³¼ì •'ì´ ì¤‘ìš”í•˜ë©°, ì‹¤íŒ¨ëŠ” ìì‚°ì…ë‹ˆë‹¤.
          3. **íƒœë„**: ëª¨ë“  ì„ íƒì˜ ê¸°ì¤€ì€ 'ì¦ê±°ì›€'ì…ë‹ˆë‹¤.

          ## [í•„ìˆ˜] ë‹µë³€ í˜•ì‹ (ì´ í˜•ì‹ì„ ì ˆëŒ€ ì–´ê¸°ì§€ ë§ˆì‹­ì‹œì˜¤)
          ë‹µë³€ì„ ì‘ì„±í•  ë•Œ ë°˜ë“œì‹œ ì•„ë˜ì˜ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”:

          ### ğŸŒ¿ Archive Sì˜ ê¸°ë¡
          > (ì—¬ê¸°ì— ë¶€ë“œëŸ¬ìš´ êµ¬ì–´ì²´ë¡œ 1~3ë¬¸ì¥ì˜ ë‹µë³€ì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ì˜¤ì§ í•œêµ­ì–´ë§Œ ì‚¬ìš©í•˜ê³  ë”°ëœ»í•˜ê²Œ ê³µê°í•´ ì£¼ì„¸ìš”.)
          '''

          # 4. ìƒê°í•˜ê¸°
          try:
              chat_completion = client.chat.completions.create(
                  messages=[
                      {'role': 'system', 'content': system_prompt},
                      {'role': 'user', 'content': f'ë‚´ìš©: {user_input}'}
                  ],
                  model='llama-3.3-70b-versatile',
                  temperature=0.1,
                  max_tokens=300,
              )
              ai_reply = chat_completion.choices[0].message.content
          except Exception as e:
              ai_reply = f'### ğŸŒ¿ Archive Sì˜ ê¸°ë¡\n> ì£„ì†¡í•´ìš”. ì ì‹œ ìƒê°ì´ ê¼¬ì˜€ë„¤ìš”. ë‹¤ì‹œ ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?'

          # 5. ë‹µê¸€ ë‹¬ê¸°
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')
          issue_number = os.environ.get('ISSUE_NUMBER')
          token = os.environ.get('GITHUB_TOKEN')

          url = f'https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/comments'
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }
          data = {'body': ai_reply}
          
          response = requests.post(url, headers=headers, json=data)
          print(response.status_code)
          "
